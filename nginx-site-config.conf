server {
    server_name converter.hqmx.net www.converter.hqmx.net;

    root /var/www/html;
    index index.html index.htm;

    # CORS headers for SharedArrayBuffer support
    add_header Cross-Origin-Opener-Policy same-origin;
    add_header Cross-Origin-Embedder-Policy require-corp;

    # 다국어 URL 라우팅: /{언어코드}/{from}-to-{to}
    location ~ ^/(en|de|es|fr|hi|id|it|ko|ja|my|ms|fil|pt|ru|th|tr|vi|zh-CN|zh-TW|ar|bn)/([a-z0-9]+)-to-([a-z0-9]+)/?$ {
        rewrite ^/([^/]+)/([^/]+)-to-([^/]+)/?$ /index.html?lang=$1&from=$2&to=$3 last;
    }

    # 언어코드만 있는 경우 (홈페이지)
    location ~ ^/(en|de|es|fr|hi|id|it|ko|ja|my|ms|fil|pt|ru|th|tr|vi|zh-CN|zh-TW|ar|bn)/?$ {
        rewrite ^/([^/]+)/?$ /index.html?lang=$1 last;
    }

    # 한국어 단축 코드 (kr → ko)
    location ~ ^/kr/([a-z0-9]+)-to-([a-z0-9]+)/?$ {
        rewrite ^/kr/([^/]+)-to-([^/]+)/?$ /index.html?lang=ko&from=$1&to=$2 last;
    }

    location ~ ^/kr/?$ {
        rewrite ^/kr/?$ /index.html?lang=ko last;
    }

    location / {
        try_files $uri $uri.html $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Service worker
    location /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Web app manifest
    location /manifest.json {
        add_header Content-Type "application/manifest+json";
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/converter.hqmx.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/converter.hqmx.net/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
    if ($host = converter.hqmx.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name converter.hqmx.net www.converter.hqmx.net;
    return 404; # managed by Certbot


}
